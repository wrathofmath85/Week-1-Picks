<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" /> <title>Spread Pool — Picks</title> <link rel="preconnect" href="https://nam04.safelinks.protection.outlook.com/?url=https%3A%2F%2Fcdn.jsdelivr.net%2F&data=05%7C02%7Cdan.fox%40brighthousefinancial.com%7C51667806ab9b4fb5d30908ddde9cc7ec%7C2658e698ac384347a56f3f96a6bfa8ff%7C0%7C0%7C638911487158208999%7CUnknown%7CTWFpbGZsb3d8eyJFbXB0eU1hcGkiOnRydWUsIlYiOiIwLjAuMDAwMCIsIlAiOiJXaW4zMiIsIkFOIjoiTWFpbCIsIldUIjoyfQ%3D%3D%7C0%7C%7C%7C&sdata=P9oEeW9wVwq3QeLqq2fJc1xrnvdvp5heZFZPBnvswqU%3D&reserved=0" /> <script src="https://nam04.safelinks.protection.outlook.com/?url=https%3A%2F%2Fcdn.jsdelivr.net%2Fnpm%2Fpapaparse%405.4.1%2Fpapaparse.min.js&data=05%7C02%7Cdan.fox%40brighthousefinancial.com%7C51667806ab9b4fb5d30908ddde9cc7ec%7C2658e698ac384347a56f3f96a6bfa8ff%7C0%7C0%7C638911487158232569%7CUnknown%7CTWFpbGZsb3d8eyJFbXB0eU1hcGkiOnRydWUsIlYiOiIwLjAuMDAwMCIsIlAiOiJXaW4zMiIsIkFOIjoiTWFpbCIsIldUIjoyfQ%3D%3D%7C0%7C%7C%7C&sdata=8gdTfcFWODFG7pzGPyklTjZAuLxZlxhnFVvrv8KpSs8%3D&reserved=0"></script>
<style>
  :root{
    --bg:#ffffff; --text:#111; --muted:#666; --rule:#ddd; --accent:#0b61ff;
    --green:#16a34a; --red:#dc2626; --gray:#6b7280; --chip:#0b5;
  }
  html,body{background:var(--bg);color:var(--text);font-family:Arial,Helvetica,sans-serif;margin:0}
  .wrap{max-width:1150px;margin:28px auto;padding:0 16px 64px}
  h1{margin:0 0 12px}
  .games{border:1px solid var(--rule);border-radius:10px;padding:12px;margin:8px 0 20px}
  .game{display:grid;grid-template-columns: 1fr auto auto auto;gap:8px;align-items:center;border-bottom:1px solid var(--rule);padding:8px 0}
  .game:last-child{border-bottom:0}
  .gline{font-weight:700}
  .gbtn{border:1px solid var(--rule);background:#f7f7f7;border-radius:8px;padding:6px 10px;cursor:pointer;font-weight:600}
  .gbtn.active{border-color:var(--accent);box-shadow:0 0 0 2px rgba(11,97,255,.15)}
  .gbtn.away.active{background:#eef3ff}
  .gbtn.home.active{background:#eefaf0}
  .gbtn.tie.active{background:#f3f4f6}
  .note{color:var(--muted);font-size:12px;margin-top:6px}

  .person{margin:22px 0 30px}
  .pname{font-weight:800;font-size:20px;margin:0 0 8px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:7px 8px;vertical-align:top}
  th{text-align:left;border-bottom:2px solid #000}
  td{border-bottom:1px solid var(--rule)}
  .col-idx{width:34px;text-align:right;color:var(--muted)}
  .col-line{width:60%}
  .result-win{color:var(--green);font-weight:700}
  .result-loss{color:var(--red);font-weight:700}
  .result-tie{color:var(--gray);font-weight:700}
  .double::after{content:" ×2";color:var(--chip);font-weight:700}
  tfoot td{font-weight:700}
</style>
</head>
<body>
<div class="wrap">
  <h1>Spread Pool — Picks</h1>

  <!-- GAME OUTCOME CONTROLS -->
  <div id="gamesPanel" class="games"></div>
  <div class="note">Tip: click a game’s Away/Home/Tie to record the result. Totals update instantly. (Double counts as ×2 by default.)</div>

  <!-- PEOPLE LIST -->
  <div id="list"></div>
</div>

<script>
/* ================== CONFIG ================== */
/* Publish each Google Sheet tab as CSV (File → Share → Publish to web → CSV) */
const CSV_URL_LINES = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTUQWcddGBeI13Qox_fKf1g9dejkd-VyZqimSwHaXPH4nO4AGE9oJo9-FzNacU4X1-xNvFvm0HOFHre/pub?gid=1347498364&single=true&output=csv";       // expects: QID,Line,Away,Home
const CSV_URL_SUBS  = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRys9xayYsuEqgGB09v1nOrwdD0U5c1Hb1ksLqQxTSBzLi3AKGeg9yPt1-eY1fry_0H-KcZLCQ1h8H6/pub?gid=0&single=true&output=csv"; // expects: Timestamp,Week,Name,Email,QID,Choice,IsDouble
const DOUBLE_COUNTS_AS = 2; // set to 1 if a Double should count the same as a normal pick

/* ================ HELPERS =================== */ const by = f => (a,b)=> f(a)<f(b)?-1:f(a)>f(b)?1:0; function escapeHtml(s){return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]))}
function qidOrder(q){ if(!q) return 9999; const s=q[0], n=parseInt(q.slice(1),10); return (s==='A'?0:1)*1000 + (isFinite(n)?n:999); } function fetchCSV(url){
  return new Promise((resolve,reject)=>{
    Papa.parse(url,{download:true,header:true,dynamicTyping:false,skipEmptyLines:true,
      complete:res=>resolve(res.data),error:err=>reject(err)});
  });
}
// Normalize team strings for loose matching: trims, drops spreads "(...)", and leading rankings "#3 "
function normTeam(s){
  s = String(s||"").trim();
  if(!s) return "";
  // remove content in parentheses at the end (spreads)
  s = s.replace(/\s*\([^)]*\)\s*$/,"").trim();
  // drop leading rank like "#3 " or "#22 "
  s = s.replace(/^#\d+\s+/,"").trim();
  return s.toLowerCase();
}

/* ============== STATE ============== */
let qidToLine = new Map();      // QID -> Line text
let qidToAway = new Map();      // QID -> Away team (raw)
let qidToHome = new Map();      // QID -> Home team (raw)
let results = new Map();        // QID -> 'away' | 'home' | 'tie'
let people = [];                // [{name, picks:[{qid, choice, isDouble}]}]

/* ============== LOAD & PREP ============== */ function normalizeLines(rows){
  rows.forEach(r=>{
    const qid = String(r["QID"]||r["qid"]||"").trim();
    const line= String(r["Line"]||r["line"]||"").trim();
    const away= String(r["Away"]||r["away"]||"").trim();
    const home= String(r["Home"]||r["home"]||"").trim();
    if(qid){
      qidToLine.set(qid, line || qid);
      qidToAway.set(qid, away);
      qidToHome.set(qid, home);
    }
  });
}

function normalizeSubs(rows){
  // Group by (Name) and keep latest timestamp set if multiple submissions
  const latest = new Map(); // name => latest ts
  rows.forEach(r=>{
    const name = String(r["Name"]||r["name"]||"").trim();
    if(!name) return;
    const ts = String(r["Timestamp"]||r["timestamp"]||"").trim();
    const prev = latest.get(name);
    if(!prev || ts > prev) latest.set(name, ts);
  });

  const byName = new Map();
  rows.forEach(r=>{
    const name   = String(r["Name"]||r["name"]||"").trim();
    const ts     = String(r["Timestamp"]||r["timestamp"]||"").trim();
    const qid    = String(r["QID"]||r["qid"]||"").trim();
    const choice = String(r["Choice"]||r["choice"]||"").trim();
    const isDouble = String(r["IsDouble"]).toUpperCase()==="TRUE";

    if(!name || !qid) return;
    if(latest.get(name) && ts !== latest.get(name)) return; // keep only lines for their latest submission

    const p = byName.get(name) || { name, picks: [] };
    p.picks.push({ qid, choice, isDouble });
    byName.set(name, p);
  });

  // sort picks by QID order
  const arr = Array.from(byName.values());
  arr.forEach(p => p.picks.sort((a,b)=> qidOrder(a.qid)-qidOrder(b.qid)));
  arr.sort(by(p => p.name.toLowerCase()));
  return arr;
}

async function loadAll(){
  const [lines, subs] = await Promise.all([ fetchCSV(CSV_URL_LINES), fetchCSV(CSV_URL_SUBS) ]);
  normalizeLines(lines);
  people = normalizeSubs(subs);
  renderGames();
  renderPeople();
}

/* ============== RENDER: GAMES (controls) ============== */ function renderGames(){
  const panel = document.getElementById('gamesPanel');
  panel.innerHTML = '';
  const qids = Array.from(qidToLine.keys()).sort((a,b)=> qidOrder(a)-qidOrder(b));

  qids.forEach(qid=>{
    const div = document.createElement('div');
    div.className = 'game';
    const away = qidToAway.get(qid) || '';
    const home = qidToHome.get(qid) || '';
    div.innerHTML = `
      <div class="gline">${escapeHtml(qid)} — ${escapeHtml(qidToLine.get(qid)||qid)}</div>
      <button class="gbtn away" data-qid="${qid}" data-val="away">${escapeHtml(away||'Away')}</button>
      <button class="gbtn home" data-qid="${qid}" data-val="home">${escapeHtml(home||'Home')}</button>
      <button class="gbtn tie"  data-qid="${qid}" data-val="tie">Tie</button>
    `;
    panel.appendChild(div);
  });

  panel.addEventListener('click', e=>{
    const btn = e.target.closest('.gbtn');
    if(!btn) return;
    const qid = btn.dataset.qid;
    const val = btn.dataset.val;          // 'away' | 'home' | 'tie'
    // toggle result (clicking active clears)
    const current = results.get(qid);
    if(current === val){ results.delete(qid); }
    else { results.set(qid, val); }
    // update active styles for that row
    const row = btn.closest('.game');
    row.querySelectorAll('.gbtn').forEach(b=> b.classList.remove('active'));
    if(results.has(qid)) row.querySelector(`.gbtn.${results.get(qid)}`)?.classList.add('active');
    renderPeople(); // re-score
  });
}

/* ============== SCORING ============== */ function scorePick(qid, choice, isDouble){
  const outcome = results.get(qid); // undefined | 'away' | 'home' | 'tie'
  if(!outcome) return { w:0, l:0, t:0 };

  const away = qidToAway.get(qid) || '';
  const home = qidToHome.get(qid) || '';

  const cNorm = normTeam(choice);
  const awayNorm = normTeam(away);
  const homeNorm = normTeam(home);

  let w=0,l=0,t=0;
  const weight = isDouble ? DOUBLE_COUNTS_AS : 1;

  if(outcome === 'tie'){
    t = weight;
  } else if(outcome === 'away'){
    if(cNorm && cNorm === awayNorm) w = weight; else l = weight;
  } else if(outcome === 'home'){
    if(cNorm && cNorm === homeNorm) w = weight; else l = weight;
  }
  return { w,l,t };
}

/* ============== RENDER: PEOPLE TABLES ============== */ function renderPeople(){
  const list = document.getElementById('list');
  list.innerHTML = '';

  people.forEach(p=>{
    let rowsHtml = '';
    let tw=0, tl=0, tt=0;

    p.picks.forEach((pk, idx)=>{
      const s = scorePick(pk.qid, pk.choice, pk.isDouble);
      tw += s.w; tl += s.l; tt += s.t;
      const cls =
        s.w ? 'result-win' :
        s.l ? 'result-loss' :
        s.t ? 'result-tie'  : '';
      rowsHtml += `
        <tr>
          <td class="col-idx">${idx+1}</td>
          <td class="col-line">${escapeHtml(qidToLine.get(pk.qid) || pk.qid)}</td>
          <td class="${cls}">${escapeHtml(pk.choice)}${pk.isDouble?'<span class="double"></span>':''}</td>
          <td>${s.w? s.w : ''}</td>
          <td>${s.l? s.l : ''}</td>
          <td>${s.t? s.t : ''}</td>
        </tr>
      `;
    });

    const table = `
      <table>
        <thead>
          <tr>
            <th class="col-idx">#</th>
            <th>Line</th>
            <th>Pick</th>
            <th>Win</th>
            <th>Loss</th>
            <th>Tie</th>
          </tr>
        </thead>
        <tbody>${rowsHtml}</tbody>
        <tfoot>
          <tr>
            <td></td>
            <td>Total</td>
            <td></td>
            <td>${tw}</td>
            <td>${tl}</td>
            <td>${tt}</td>
          </tr>
        </tfoot>
      </table>
    `;

    const card = document.createElement('div');
    card.className = 'person';
    card.innerHTML = `<div class="pname">${escapeHtml(p.name)}</div>` + table;
    list.appendChild(card);
  });
}

/* ============== GO ============== */
loadAll();
</script>
</body>
</html>

